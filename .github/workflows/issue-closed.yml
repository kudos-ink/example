name: Issue Closed Event

on:
  issues:
    types:
      - closed

jobs:
  process_issue:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Check for "payment" label
        id: check_label
        run: |
          issue_labels=$(jq -r '.issue.labels[].name' $GITHUB_EVENT_PATH)
          echo "::set-output name=has_payment_label::false"

          for label in $issue_labels; do
            if [ "$label" == "payment" ]; then
              echo "::set-output name=has_payment_label::true"
              break
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Check if Issue has Associated PR
        if: steps.check_label.outputs.has_payment_label == 'true' 
        id: check_pr
        run: |
          if [ "${{ github.event.issue.pull_request.html_url }}" == "null" ]; then
            echo "Issue is not associated with a pull request. Will not close the issue."
            exit 1
          fi
        continue-on-error: true

      - name: Get PR Information
        id: get_pr_info
        if: steps.check_label.outputs.has_payment_label == 'true' && steps.check_pr.outcome == 'success'
        run: |
          pr_url="${{ github.event.issue.pull_request.url }}"
          pr_state=$(curl -s -H "Authorization: Bearer $GH_TOKEN" $pr_url | jq -r '.state')
          pr_assignee=$(curl -s -H "Authorization: Bearer $GH_TOKEN" $pr_url | jq -r '.assignee.login')
          echo "::set-output name=pr_state::${pr_state}"
          echo "::set-output name=pr_assignee::${pr_assignee}"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Close Issue if Conditions Met
        if: steps.check_label.outputs.has_payment_label == 'true' && steps.get_pr_info.outputs.pr_state == 'closed' && steps.get_pr_info.outputs.pr_assignee != 'null'
        id: assignee
        run: |
          hash=$(echo -n ${{ steps.get_pr_info.outputs.assignee }} | sha256sum | awk '{print $1}')
          hex=0x$hash
          echo "::set-output name=hash::$hex"

      - name: Call contract
        id: approve
        uses: kudos-ink/approve@059499ebc582013b4b354d7b0d04541025a52ec8
        if: steps.check_label.outputs.has_payment_label == 'true' && steps.get_pr_info.outputs.pr_state == 'closed' && steps.get_pr_info.outputs.pr_assignee != 'null'
        with:
          ws-provider-url: ${{ vars.WS_PROVIDER_URL }}
          mnemonic-phrase: ${{ secrets.MNEMONIC_PHRASE }}
          contract-address: ${{ vars.CONTRACT_ADDRESS }}
          contract-abi: ${{ vars.ABI }}
          contribution-id: ${{ github.event.issue.id }}
          contributor-identity: ${{ steps.assignee.outputs.hash }}

      - name: Print Output
        id: output
        if: steps.check_label.outputs.has_payment_label == 'true' && steps.get_pr_info.outputs.pr_state == 'closed' && steps.get_pr_info.outputs.pr_assignee != 'null'
        run: echo "${{ steps.approve.outputs.hash }}"
