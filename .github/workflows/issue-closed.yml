name: Issue Closed Event

on:
  issues:
    types:
      - closed

jobs:
  process_issue:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Check for "payment" label
        id: check_label
        run: |
          issue_labels=$(jq -r '.issue.labels[].name' $GITHUB_EVENT_PATH)
          echo "::set-output name=has_payment_label::false"

          for label in $issue_labels; do
            if [ "$label" == "payment" ]; then
              echo "::set-output name=has_payment_label::true"
              break
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Get PR assignee
        id: pr_info
        if: steps.check_label.outputs.has_payment_label == 'true'
        run: |
          pr_number=$(jq -r '.issue.pull_request.url' $GITHUB_EVENT_PATH | awk -F/ '{print $NF}')
          assignee=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${pr_number}" | jq -r '.assignee.login')
          echo "::set-output name=assignee::$assignee"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Hash Assigned User
        id: assignee
        if: steps.check_label.outputs.has_payment_label == 'true'
        run: |
          hash=$(echo -n ${{ steps.pr_info.outputs.assignee }} | sha256sum | awk '{print $1}')
          hex=0x$hash
          echo "::set-output name=hash::$hex"

      - name: Call contract
        id: approve
        uses: kudos-ink/approve@059499ebc582013b4b354d7b0d04541025a52ec8
        if: steps.check_label.outputs.has_payment_label == 'true' #&& steps.check_assignee.outputs.assignee != 'null'
        with:
          ws-provider-url: ${{ vars.WS_PROVIDER_URL }}
          mnemonic-phrase: ${{ secrets.MNEMONIC_PHRASE }}
          contract-address: ${{ vars.CONTRACT_ADDRESS }}
          contract-abi: ${{ vars.ABI }}
          contribution-id: ${{ github.event.issue.id }}
          contributor-identity: ${{ steps.assignee.outputs.hash }}

      - name: Print Output
        id: output
        run: echo "${{ steps.approve.outputs.hash }}"
